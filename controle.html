<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Contr√¥le Qualit√© - Nettoyage</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f0f2f5;
      padding: 10px;
      max-width: 750px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #10b981;
      font-size: 22px;
      margin: 10px 0;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    label, select, input, textarea, button {
      font-size: 14px;
    }
    select, input[type="text"], textarea, input[type="file"] {
      width: 100%; padding: 10px; margin-bottom: 12px;
      border: 1px solid #ccc; border-radius: 8px;
    }
    .checklist-item {
      display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;
      background: #f9fafb; padding: 8px; border-radius: 8px;
    }
    .checklist-options label {
      font-size: 13px; margin-right: 8px;
    }
    button {
      background: #10b981; color: white; padding: 10px;
      border: none; border-radius: 8px; cursor: pointer;
    }
    button:hover { background: #059669; }
    .btn-danger { background: #ef4444; }
    .btn-danger:hover { background: #dc2626; }
    .photo-preview {
      max-width: 100%; margin-bottom: 10px; border-radius: 8px;
    }
    .btn-row {
      display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <h1>Contr√¥le Qualit√© - Nettoyage</h1>

  <div class="card">
    <label for="chantierSelect">Chantier :</label>
    <select id="chantierSelect"></select>
    <input type="text" id="nouveauChantier" placeholder="Nouveau chantier..." />
    <div class="btn-row">
      <button onclick="ajouterChantier()">‚ûï Ajouter</button>
      <button class="btn-danger" onclick="supprimerChantier()">üóë Supprimer</button>
      <button onclick="location.href='suivi.html'">üìà Suivi de qualit√©</button>
    </div>
  </div>

  <div class="card">
    <form id="controleForm">
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input type="text" id="newChecklistItem" placeholder="Nouvelle ligne de contr√¥le..." />
        <button type="button" onclick="ajouterLigneChecklist()">Ajouter</button>
        <button type="button" class="btn-danger" onclick="supprimerLignesSelectionnees()">Supprimer</button>
      </div>

      <div id="checklistContainer"></div>

      <label for="observations">Observations :</label>
      <textarea id="observations" rows="4"></textarea>

      <label for="photos">Ajouter des photos :</label>
      <input type="file" id="photos" accept="image/*" multiple />
      <div id="photoGallery"></div>

      <div class="btn-row">
        <button type="button" onclick="genererPDF()">üìÑ G√©n√©rer le PDF</button>
        <button type="reset" class="btn-danger">‚ôª R√©initialiser</button>
      </div>
    </form>
  </div>

  <!-- Camembert cach√© -->
  <canvas id="pieChartCanvas" width="300" height="300" style="display:none;"></canvas>

  <script>
    const chantierSelect = document.getElementById("chantierSelect");
    let chantiers = JSON.parse(localStorage.getItem("chantiersListe") || "[]");

    function afficherChantiers() {
      chantierSelect.innerHTML = "";
      chantiers.sort().forEach(chantier => {
        const option = document.createElement("option");
        option.value = chantier;
        option.textContent = chantier;
        chantierSelect.appendChild(option);
      });
      chantierSelect.value = localStorage.getItem("chantierSelectionne") || chantierSelect.value;
    }

    function ajouterChantier() {
      const nom = document.getElementById("nouveauChantier").value.trim();
      if (nom && !chantiers.includes(nom)) {
        chantiers.push(nom);
        localStorage.setItem("chantiersListe", JSON.stringify(chantiers));
        afficherChantiers();
        chantierSelect.value = nom;
        localStorage.setItem("chantierSelectionne", nom);
      }
    }

    function supprimerChantier() {
      const nom = chantierSelect.value;
      if (confirm("Supprimer ce chantier ?")) {
        chantiers = chantiers.filter(c => c !== nom);
        localStorage.setItem("chantiersListe", JSON.stringify(chantiers));
        afficherChantiers();
      }
    }

    chantierSelect.addEventListener("change", () => {
      localStorage.setItem("chantierSelectionne", chantierSelect.value);
    });

    function ajouterLigneChecklist(nom = null) {
      const input = document.getElementById("newChecklistItem");
      if (!nom) nom = input.value.trim();
      if (!nom) return;

      const radioName = "item_" + nom.replace(/\s+/g, "_");
      const div = document.createElement("div");
      div.className = "checklist-item";
      div.innerHTML = `
        <input type="checkbox" class="delete-checkbox" />
        <span>${nom}</span>
        <div class="checklist-options">
          <label><input type="radio" name="${radioName}" value="Bon" /> ‚úÖ Bon</label>
          <label><input type="radio" name="${radioName}" value="Passable" /> ‚ö† Passable</label>
          <label><input type="radio" name="${radioName}" value="Mal fait" /> ‚ùå Mal fait</label>
        </div>
      `;
      document.getElementById("checklistContainer").appendChild(div);
      input.value = "";
    }

    function supprimerLignesSelectionnees() {
      document.querySelectorAll(".delete-checkbox:checked").forEach(cb => cb.closest(".checklist-item").remove());
    }

    function ajouterLigneChecklistInitiales() {
      [
        "Nettoyage digicodes/interphone", "Vitrerie miroiterie", "Encadrements vitres/portes",
        "Tapis", "Aspirateur sols", "Lavage sols", "Escaliers services",
        "Toiles d'araign√©es", "Rampes/gardes corps", "Porte de service",
        "Gaines techniques", "Plinthes", "Bo√Ætes aux lettres",
        "Vidage poubelle", "Poche poubelle", "Ascenseurs (int/ext)",
        "Rails ascenseur", "Commandes ascenseur", "Conteneurs", "Local conteneurs"
      ].forEach(nom => ajouterLigneChecklist(nom));
    }

    const photoInput = document.getElementById("photos");
    const photoGallery = document.getElementById("photoGallery");
    let photoDataUrls = [];

    photoInput.addEventListener("change", function () {
      Array.from(this.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const maxWidth = 800;
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
            photoDataUrls.push(dataUrl);
            const thumb = document.createElement("img");
            thumb.src = dataUrl;
            thumb.className = "photo-preview";
            photoGallery.appendChild(thumb);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
      this.value = "";
    });

    async function genererPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const chantier = chantierSelect.value;
      const date = new Date().toLocaleString('fr-FR');
      const observations = document.getElementById("observations").value;
      const items = document.querySelectorAll(".checklist-item");

      let bon = 0, passable = 0, mal = 0;
      let y = 20;
      doc.setFontSize(16);
      doc.text(`Rapport Contr√¥le Qualit√© - ${chantier}`, 10, y);
      y += 10;
      doc.setFontSize(12);
      doc.text(`Date : ${date}`, 10, y);
      y += 10;

      items.forEach(item => {
        const nom = item.querySelector("span").textContent;
        const radios = item.querySelectorAll("input[type='radio']");
        let value = "non √©valu√©";
        radios.forEach(r => { if (r.checked) value = r.value; });
        if (value === "Bon") bon++;
        else if (value === "Passable") passable++;
        else if (value === "Mal fait") mal++;
        doc.text(`- ${nom} : ${value}`, 10, y);
        y += 8;
        if (y > 270) { doc.addPage(); y = 20; }
      });

      doc.addPage();
      doc.text("Observations :", 10, 20);
      doc.text(doc.splitTextToSize(observations, 180), 10, 30);

      const total = bon + passable + mal;
      const score = total ? Math.round((bon * 100 + passable * 50) / total) : 0;

      // Camembert
      const pieCanvas = document.getElementById("pieChartCanvas");
      const pieChart = new Chart(pieCanvas, {
        type: "pie",
        data: {
          labels: ["Bon", "Passable", "Mal fait"],
          datasets: [{
            data: [bon, passable, mal],
            backgroundColor: ["#10b981", "#f59e0b", "#ef4444"]
          }]
        }
      });

      setTimeout(() => {
        html2canvas(pieCanvas).then(canvas => {
          const imgData = canvas.toDataURL("image/png");
          doc.addPage();
          doc.text(`Score global : ${score}/100`, 10, 20);
          doc.addImage(imgData, "PNG", 40, 30, 130, 130);

          // Sauvegarde PDF dans localStorage
          doc.output("blob").arrayBuffer().then(buffer => {
            const blob = new Blob([buffer], { type: "application/pdf" });
            const url = URL.createObjectURL(blob);
            const nomFichier = `rapport-${chantier}-${date}.pdf`;
            const fichiers = JSON.parse(localStorage.getItem("pdfsStockes") || "[]");
            fichiers.push({ chantier, date, nom: nomFichier, blobUrl: url });
            localStorage.setItem("pdfsStockes", JSON.stringify(fichiers));

            window.open(url, "_blank");
          });
        });
      }, 500);
    }

    document.addEventListener("DOMContentLoaded", () => {
      afficherChantiers();
      ajouterLigneChecklistInitiales();
    });
  </script>
</body>
</html>
