<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Contr√¥le Qualit√© - Nettoyage</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f0f2f5;
      padding: 10px;
      max-width: 750px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #10b981;
      font-size: 22px;
      margin: 10px 0;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
    select, input[type="text"], textarea, input[type="file"] {
      width: 100%; padding: 10px; margin-bottom: 12px;
      border: 1px solid #ccc; border-radius: 8px;
      font-size: 14px; box-sizing: border-box;
    }
    .checklist-item { display: flex; flex-wrap: wrap; align-items: center; gap: 5px; margin-bottom: 8px; padding: 6px; border-radius: 8px; }
    .checklist-item span { flex: 1 1 100%; font-size: 14px; }
    .checklist-options label { font-weight: normal; font-size: 12px; margin-right: 5px; }
    button {
      background: #10b981; color: white; padding: 10px;
      border: none; border-radius: 8px; font-size: 14px; cursor: pointer;
    }
    button:hover { background: #059669; }
    .btn-danger { background: #ef4444; }
    .btn-danger:hover { background: #dc2626; }
    .add-checklist-container { display: flex; gap: 5px; margin-bottom: 10px; }
    .add-checklist-container input[type="text"] { flex: 1; }
    .photo-preview { max-width: 100%; border-radius: 12px; display: block; }
    .photo-gallery { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .btn-row { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <h1>Contr√¥le Qualit√© - Nettoyage</h1>

  <div class="card">
    <label for="chantierSelect">Chantier :</label>
    <select id="chantierSelect"></select>
    <input type="text" id="nouveauChantier" placeholder="Nouveau chantier..." />
    <div class="btn-row">
      <button type="button" onclick="ajouterChantier()">‚ûï Ajouter</button>
      <button type="button" class="btn-danger" onclick="supprimerChantier()">üóë Supprimer</button>
      <button onclick="location.href='suivi.html'">üìà Suivi de qualit√©</button>
    </div>
  </div>

  <div class="card">
    <form id="controleForm">
      <div class="add-checklist-container">
        <input type="text" id="newChecklistItem" placeholder="Nouvelle ligne de contr√¥le..." />
        <button type="button" onclick="ajouterLigneChecklist()">Ajouter</button>
        <button type="button" class="btn-danger" onclick="supprimerLignesSelectionnees()">Suppr.</button>
      </div>

      <div class="checklist" id="checklistContainer"></div>

      <label for="observations">Observations :</label>
      <textarea id="observations" rows="4" placeholder="Observations suppl√©mentaires..."></textarea>

      <label for="photos">Ajouter des photos :</label>
      <input type="file" id="photos" accept="image/*" capture="environment" multiple />
      <div id="photoGallery" class="photo-gallery"></div>

      <div class="btn-row">
        <button type="button" onclick="genererPDF()">üìÑ G√©n√©rer le PDF</button>
        <button type="reset" class="btn-danger">‚ôª R√©initialiser</button>
      </div>
    </form>
  </div>

  <canvas id="pieChartCanvas" width="300" height="300" style="display:none;"></canvas>

  <script>
    // GESTION CHANTIERS
    let chantiers = JSON.parse(localStorage.getItem("chantiersListe") || "[]");
    const chantierSelect = document.getElementById("chantierSelect");

    function afficherChantiers() {
      chantierSelect.innerHTML = "";
      chantiers.sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));
      chantiers.forEach(nom => {
        const option = document.createElement("option");
        option.value = nom;
        option.textContent = nom;
        chantierSelect.appendChild(option);
      });
      const sauvegarde = localStorage.getItem("chantierSelectionne");
      if (sauvegarde) chantierSelect.value = sauvegarde;
    }

    function ajouterChantier() {
      const nom = document.getElementById("nouveauChantier").value.trim();
      if (nom && !chantiers.includes(nom)) {
        chantiers.push(nom);
        localStorage.setItem("chantiersListe", JSON.stringify(chantiers));
        document.getElementById("nouveauChantier").value = "";
        afficherChantiers();
      }
    }

    function supprimerChantier() {
      const nom = chantierSelect.value;
      if (nom && confirm(`Supprimer le chantier "${nom}" ?`)) {
        chantiers = chantiers.filter(c => c !== nom);
        localStorage.setItem("chantiersListe", JSON.stringify(chantiers));
        afficherChantiers();
      }
    }

    chantierSelect.addEventListener("change", () => {
      localStorage.setItem("chantierSelectionne", chantierSelect.value);
    });

    document.addEventListener("DOMContentLoaded", () => {
      afficherChantiers();
      ajouterLigneChecklistInitiales();
    });

    function ajouterLigneChecklist(nom = null) {
      const input = document.getElementById("newChecklistItem");
      if (!nom) nom = input.value.trim();
      if (!nom) return;
      const container = document.getElementById("checklistContainer");
      const radioName = "c_" + nom.replace(/\s+/g, "_");
      const item = document.createElement("div");
      item.className = "checklist-item";
      item.innerHTML = `
        <input type="checkbox" class="delete-checkbox" />
        <span>${nom}</span>
        <div class="checklist-options">
          <label><input type="radio" name="${radioName}" value="Bon" /> ‚úÖ Bon</label>
          <label><input type="radio" name="${radioName}" value="Passable" /> ‚ö† Passable</label>
          <label><input type="radio" name="${radioName}" value="Mal fait" /> ‚ùå Mal fait</label>
        </div>`;
      container.appendChild(item);
      input.value = "";
    }

    function ajouterLigneChecklistInitiales() {
      const lignes = [
        "Nettoyage digicodes/interphone", "Vitrerie miroiterie", "Encadrements vitres/portes",
        "Tapis", "Aspirateur sols", "Lavage sols", "Escaliers services",
        "Toiles d'araign√©es", "Rampes/gardes corps", "Porte de service",
        "Gaines techniques", "Plinthes", "Bo√Ætes aux lettres",
        "Vidage poubelle", "Poche poubelle", "Ascenseurs (int/ext)",
        "Rails ascenseur", "Commandes ascenseur", "Conteneurs", "Local conteneurs"
      ];
      lignes.forEach(ajouterLigneChecklist);
    }

    function supprimerLignesSelectionnees() {
      document.querySelectorAll(".delete-checkbox:checked").forEach(cb => {
        cb.closest(".checklist-item").remove();
      });
    }

    const photoInput = document.getElementById("photos");
    const photoGallery = document.getElementById("photoGallery");
    let photoDataUrls = [];

    photoInput.addEventListener("change", function () {
      Array.from(this.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const scale = Math.min(1000 / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
            photoDataUrls.push(dataUrl);
            const thumb = document.createElement("img");
            thumb.src = dataUrl;
            thumb.className = "photo-preview";
            photoGallery.appendChild(thumb);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    });

    async function genererPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const chantier = chantierSelect.value || "Sans nom";
      const date = new Date().toLocaleString('fr-FR');
      const observations = document.getElementById("observations").value;
      const items = document.querySelectorAll(".checklist-item");
      let bon = 0, passable = 0, mal = 0;
      let y = 15;

      doc.setFontSize(16);
      doc.setTextColor(16, 185, 129);
      doc.text("Rapport de Contr√¥le Qualit√© - Nettoyage", 10, y);
      y += 10;
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Chantier : ${chantier}`, 10, y);
      y += 8;
      doc.text(`Date : ${date}`, 10, y);
      y += 12;

      items.forEach(item => {
        const nom = item.querySelector("span").textContent;
        const radios = item.querySelectorAll("input[type='radio']");
        let result = "non √©valu√©";
        radios.forEach(r => { if (r.checked) result = r.value; });
        if (result === "Bon") bon++;
        else if (result === "Passable") passable++;
        else if (result === "Mal fait") mal++;

        doc.setTextColor(result === "Bon" ? 34 : result === "Passable" ? 234 : result === "Mal fait" ? 239 : 0,
                         result === "Bon" ? 197 : result === "Passable" ? 179 : result === "Mal fait" ? 68 : 0,
                         result === "Bon" ? 94  : result === "Passable" ? 8   : result === "Mal fait" ? 68 : 0);
        doc.text(`- ${nom} : ${result}`, 10, y);
        y += 8;
        if (y > 270) { doc.addPage(); y = 15; }
      });

      y += 5;
      doc.setTextColor(0, 0, 0);
      doc.text("Observations :", 10, y);
      y += 8;
      doc.text(doc.splitTextToSize(observations, 180), 10, y);

      const total = bon + passable + mal;
      const score = total === 0 ? 0 : Math.round(((bon * 100 + passable * 50) / (total * 100)) * 100);

      const pieCanvas = document.getElementById("pieChartCanvas");
      const pieChart = new Chart(pieCanvas, {
        type: 'pie',
        data: {
          labels: ["Bon", "Passable", "Mal fait"],
          datasets: [{ data: [bon, passable, mal], backgroundColor: ["#10b981", "#f59e0b", "#ef4444"] }]
        },
        options: { responsive: false }
      });

      setTimeout(() => {
        html2canvas(pieCanvas).then(canvas => {
          const imgData = canvas.toDataURL("image/png");
          doc.addPage();
          doc.setFontSize(16);
          doc.text("Score global : " + score + "/100", 10, 20);
          doc.addImage(imgData, "PNG", 50, 30, 100, 100);

          const pdfBase64 = doc.output("datauristring");
          const pdfs = JSON.parse(localStorage.getItem("pdfsStockes") || "[]");
          pdfs.push({ chantier, date, nom: `rapport-${chantier}-${date}.pdf`, base64: pdfBase64 });
          localStorage.setItem("pdfsStockes", JSON.stringify(pdfs));

          const newTab = window.open();
          newTab.document.write(`<iframe width='100%' height='100%' src='${pdfBase64}'></iframe>`);
        });
      }, 500);
    }
  </script>
</body>
</html>
