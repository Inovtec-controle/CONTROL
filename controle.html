<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Contr√¥le Qualit√© - Nettoyage</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f0f2f5;
      padding: 10px;
      max-width: 750px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #10b981;
      font-size: 22px;
      margin: 10px 0;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    label, .checklist-item span {
      display: block;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 5px;
    }
    select, input[type="text"], textarea, input[type="file"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    .checklist-item {
      margin-bottom: 10px;
      border-bottom: 1px dashed #ccc;
      padding-bottom: 5px;
    }
    .checklist-options label {
      margin-right: 10px;
      font-weight: normal;
      font-size: 12px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }
    button {
      background: #10b981;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    button:hover {
      background: #059669;
    }
    .btn-danger {
      background: #ef4444;
    }
    .photo-gallery {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .photo-preview {
      width: 100%;
      border-radius: 8px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <h1>Contr√¥le Qualit√© - Nettoyage</h1>

  <div class="card">
    <label for="chantierSelect">Chantier :</label>
    <select id="chantierSelect"></select>
    <input type="text" id="nouveauChantier" placeholder="Nouveau chantier..." />
    <div class="btn-row">
      <button onclick="ajouterChantier()">‚ûï Ajouter</button>
      <button class="btn-danger" onclick="supprimerChantier()">üóë Supprimer</button>
      <button onclick="location.href='suivi.html'">üìà Suivi de qualit√©</button>
    </div>
  </div>

  <div class="card">
    <form id="controleForm">
      <label>Checklist :</label>
      <div id="checklistContainer"></div>
      <input type="text" id="newChecklistItem" placeholder="Nouvelle ligne..." />
      <div class="btn-row">
        <button type="button" onclick="ajouterLigneChecklist()">Ajouter</button>
      </div>

      <label for="observations">Observations :</label>
      <textarea id="observations" rows="4"></textarea>

      <label for="photos">Ajouter des photos :</label>
      <input type="file" id="photos" accept="image/*" multiple capture="environment" />
      <div class="photo-gallery" id="photoGallery"></div>

      <div class="btn-row">
        <button type="button" onclick="genererPDF()">üìÑ G√©n√©rer le PDF</button>
        <button type="reset" class="btn-danger">‚ôª R√©initialiser</button>
      </div>
    </form>
  </div>

  <canvas id="pieChartCanvas" width="300" height="300" style="display:none;"></canvas>

  <script>
    const chantierSelect = document.getElementById("chantierSelect");
    let chantiers = JSON.parse(localStorage.getItem("chantiersListe") || "[]");

    function afficherChantiers() {
      chantierSelect.innerHTML = "";
      chantiers.sort();
      chantiers.forEach(nom => {
        const option = document.createElement("option");
        option.value = nom;
        option.textContent = nom;
        chantierSelect.appendChild(option);
      });
      const selection = localStorage.getItem("chantierSelectionne");
      if (selection) chantierSelect.value = selection;
    }

    function ajouterChantier() {
      const nom = document.getElementById("nouveauChantier").value.trim();
      if (!nom || chantiers.includes(nom)) return;
      chantiers.push(nom);
      localStorage.setItem("chantiersListe", JSON.stringify(chantiers));
      afficherChantiers();
      document.getElementById("nouveauChantier").value = "";
    }

    function supprimerChantier() {
      const selected = chantierSelect.value;
      if (!selected || !confirm("Supprimer ce chantier ?")) return;
      chantiers = chantiers.filter(c => c !== selected);
      localStorage.setItem("chantiersListe", JSON.stringify(chantiers));
      afficherChantiers();
    }

    chantierSelect.addEventListener("change", () => {
      localStorage.setItem("chantierSelectionne", chantierSelect.value);
    });

    function ajouterLigneChecklist(nom = null) {
      const input = document.getElementById("newChecklistItem");
      if (!nom) nom = input.value.trim();
      if (!nom) return;
      const id = `item_${Date.now()}`;
      const div = document.createElement("div");
      div.className = "checklist-item";
      div.innerHTML = `
        <span>${nom}</span>
        <div class="checklist-options">
          <label><input type="radio" name="${id}" value="Bon"> ‚úÖ Bon</label>
          <label><input type="radio" name="${id}" value="Passable"> ‚ö† Passable</label>
          <label><input type="radio" name="${id}" value="Mal fait"> ‚ùå Mal fait</label>
        </div>
      `;
      document.getElementById("checklistContainer").appendChild(div);
      input.value = "";
    }

    document.addEventListener("DOMContentLoaded", () => {
      afficherChantiers();
      [
        "Sol propre", "Poubelles vid√©es", "Vitres propres", "Interphone nettoy√©"
      ].forEach(ajouterLigneChecklist);
    });

    const photoInput = document.getElementById("photos");
    const photoGallery = document.getElementById("photoGallery");
    let photoDataUrls = [];

    photoInput.addEventListener("change", function () {
      Array.from(this.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const scale = Math.min(1000 / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
            photoDataUrls.push(dataUrl);
            const thumb = document.createElement("img");
            thumb.src = dataUrl;
            thumb.className = "photo-preview";
            photoGallery.appendChild(thumb);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    });

    async function genererPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const chantier = chantierSelect.value;
      const date = new Date().toLocaleString("fr-FR");
      const observations = document.getElementById("observations").value;

      let bon = 0, passable = 0, mal = 0;
      let y = 10;

      doc.setFontSize(14);
      doc.text(`Rapport Contr√¥le Qualit√©`, 10, y); y += 8;
      doc.setFontSize(12);
      doc.text(`Chantier : ${chantier}`, 10, y); y += 6;
      doc.text(`Date : ${date}`, 10, y); y += 8;

      document.querySelectorAll(".checklist-item").forEach(item => {
        const nom = item.querySelector("span").textContent;
        const value = item.querySelector("input[type='radio']:checked")?.value || "non √©valu√©";
        if (value === "Bon") bon++;
        else if (value === "Passable") passable++;
        else if (value === "Mal fait") mal++;
        doc.text(`- ${nom} : ${value}`, 10, y);
        y += 6;
        if (y > 270) { doc.addPage(); y = 10; }
      });

      doc.text("Observations :", 10, y); y += 6;
      doc.text(doc.splitTextToSize(observations, 180), 10, y); y += 20;

      const total = bon + passable + mal;
      const score = total === 0 ? 0 : Math.round(((bon * 100 + passable * 50) / (total * 100)) * 100);

      // G√©n√©rer graphique
      const chartCanvas = document.getElementById("pieChartCanvas");
      new Chart(chartCanvas, {
        type: "pie",
        data: {
          labels: ["Bon", "Passable", "Mal fait"],
          datasets: [{
            data: [bon, passable, mal],
            backgroundColor: ["#10b981", "#f59e0b", "#ef4444"]
          }]
        },
        options: { responsive: false }
      });

      setTimeout(() => {
        html2canvas(chartCanvas).then(canvas => {
          doc.addPage();
          doc.text(`Score : ${score}/100`, 10, 20);
          doc.addImage(canvas.toDataURL("image/png"), "PNG", 40, 30, 120, 120);

          // Ajouter les photos
          photoDataUrls.forEach((url, index) => {
            if (index % 2 === 0) doc.addPage();
            doc.addImage(url, "JPEG", 15, 40, 180, 120);
          });

          const pdfBase64 = doc.output("datauristring");
          const nomPDF = `rapport-${chantier}-${date}.pdf`;
          const pdfs = JSON.parse(localStorage.getItem("pdfsStockes") || "[]");
          pdfs.push({ chantier, date, nom: nomPDF, base64: pdfBase64 });
          localStorage.setItem("pdfsStockes", JSON.stringify(pdfs));

          const link = document.createElement("a");
          link.href = pdfBase64;
          link.download = nomPDF;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      }, 500);
    }
  </script>
</body>
</html>