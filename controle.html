<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Contr√¥le Qualit√© - Nettoyage</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f0f2f5;
      padding: 10px;
      max-width: 750px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #10b981;
      font-size: 22px;
      margin: 10px 0;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
    input[type="text"], textarea, input[type="file"] {
      width: 100%; padding: 10px; margin-bottom: 12px;
      border: 1px solid #ccc; border-radius: 8px;
      font-size: 14px; box-sizing: border-box;
    }
    textarea { resize: none; }
    .checklist-item { display: flex; flex-wrap: wrap; align-items: center; gap: 5px; margin-bottom: 8px; padding: 6px; border-radius: 8px; }
    .checklist-item span { flex: 1 1 100%; font-size: 14px; }
    .checklist-options label { font-weight: normal; font-size: 12px; margin-right: 5px; }
    button {
      background: #10b981; color: white; padding: 10px;
      border: none; border-radius: 8px; font-size: 14px; cursor: pointer;
    }
    button:hover { background: #059669; }
    .btn-danger { background: #ef4444; }
    .btn-danger:hover { background: #dc2626; }
    .add-checklist-container { display: flex; gap: 5px; margin-bottom: 10px; }
    .add-checklist-container input[type="text"] { flex: 1; }
    .photo-preview { max-width: 100%; border-radius: 12px; display: block; }
    .photo-gallery { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .btn-row { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
    #chartCanvas { display: none; }
  </style>
</head>
<body>
  <h1>Contr√¥le Qualit√© - Nettoyage</h1>
  <div class="card">
    <form id="controleForm">
      <label for="zone">Chantier :</label>
      <input type="text" id="zone" placeholder="Ex: Bureau 204" required />

      <div class="add-checklist-container">
        <input type="text" id="newChecklistItem" placeholder="Nouvelle ligne de contr√¥le..." />
        <button type="button" onclick="ajouterLigneChecklist()">Ajouter</button>
        <button type="button" class="btn-danger" onclick="supprimerLignesSelectionnees()">Suppr.</button>
      </div>

      <div class="checklist" id="checklistContainer"></div>

      <label for="observations">Observations :</label>
      <textarea id="observations" rows="4" placeholder="Observations suppl√©mentaires..."></textarea>

      <label for="photos">Ajouter des photos :</label>
      <input type="file" id="photos" accept="image/*" capture="environment" multiple />
      <div id="photoGallery" class="photo-gallery"></div>

      <div class="btn-row">
        <button type="button" onclick="genererPDF()">üìÑ G√©n√©rer le PDF</button>
        <button type="reset" class="btn-danger">‚ôª R√©initialiser</button>
      </div>
    </form>
  </div>

  <canvas id="chartCanvas" width="400" height="400"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const photoInput = document.getElementById("photos");
    const photoGallery = document.getElementById("photoGallery");
    let photoDataUrls = [];

    photoInput.addEventListener("change", function() {
      Array.from(this.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const maxWidth = 1000;
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
            photoDataUrls.push(dataUrl);

            const thumb = document.createElement("img");
            thumb.src = dataUrl;
            thumb.className = "photo-preview";
            photoGallery.appendChild(thumb);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
      this.value = "";
    });

    function ajouterLigneChecklist(nom = null) {
      const input = document.getElementById("newChecklistItem");
      if (!nom) nom = input.value.trim();
      if (!nom) return;

      const radioName = "c_" + nom.replace(/\s+/g, "_");
      const container = document.getElementById("checklistContainer");
      const item = document.createElement("div");
      item.className = "checklist-item";
      item.innerHTML = `
        <input type="checkbox" class="delete-checkbox" />
        <span>${nom}</span>
        <div class="checklist-options">
          <label><input type="radio" name="${radioName}" value="Bon" /> ‚úÖ Bon</label>
          <label><input type="radio" name="${radioName}" value="Passable" /> ‚ö† Passable</label>
          <label><input type="radio" name="${radioName}" value="Mal fait" /> ‚ùå Mal fait</label>
        </div>
      `;
      container.appendChild(item);
      input.value = "";
    }

    function supprimerLignesSelectionnees() {
      document.querySelectorAll(".checklist-item").forEach(item => {
        if (item.querySelector(".delete-checkbox").checked) item.remove();
      });
    }

    function ajouterLigneChecklistInitiales() {
      [
        "Nettoyage des digicodes et interphone",
        "Vitrerie miroiterie / mouilleur raclette",
        "Vitrerie miroiterie / enl√®vement des trace de doigt",
        "Nettoyage des encadrements des vitres et portes d'entr√©e",
        "Enroulement de tapis",
        "Aspirations des sols",
        "Lavages des sols",
        "Aspirations des escaliers de services",
        "Lavage des escaliers de service",
        "Enl√®vements de toiles d'araign√©es",
        "Nettoyage des rampes et des gardes corps",
        "Nettoyage porte de service",
        "Nettoyage des gaines techniques",
        "D√©poussi√©rage des plinthes",
        "Nettoyage bloc boites aux lettres",
        "Vidage poubelle",
        "Mise en poche poubelle",
        "Nettoyage fa√ßades ascenseurs ext√©rieures",
        "Nettoyage fa√ßades ascenseurs int√©rieures",
        "Nettoyages des tranches lat√©rales",
        "Nettoyage des rails de l'ascenseur",
        "Nettoyage des plaques de commandes ascenseurs",
        "Rentr√© conteneurs",
        "Sortie conteneurs",
        "Nettoyage et d√©sinfection des conteneurs",
        "Lavage du local conteneur"
      ].forEach(nom => ajouterLigneChecklist(nom));
    }

    document.addEventListener("DOMContentLoaded", ajouterLigneChecklistInitiales);

    async function genererPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const chantier = document.getElementById("zone").value;
      const observations = document.getElementById("observations").value;
      const items = document.querySelectorAll(".checklist-item");
      const date = new Date().toLocaleString('fr-FR');

      let bonCount = 0, passableCount = 0, malCount = 0;
      let y = 15;

      doc.setFontSize(16);
      doc.setTextColor(16, 185, 129);
      doc.text("Rapport de Contr√¥le Qualit√© - Nettoyage", 10, y);
      y += 10;
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Chantier : ${chantier}`, 10, y);
      y += 8;
      doc.text(`Date : ${date}`, 10, y);
      y += 12;

      items.forEach((item) => {
        const nom = item.querySelector("span").textContent;
        const radios = item.querySelectorAll("input[type='radio']");
        let result = "non √©valu√©";
        radios.forEach(r => { if (r.checked) result = r.value; });

        if (result === "Bon") bonCount++;
        else if (result === "Passable") passableCount++;
        else if (result === "Mal fait") malCount++;

        doc.setTextColor(result === "Bon" ? 34 : result === "Passable" ? 234 : result === "Mal fait" ? 239 : 0,
                         result === "Bon" ? 197 : result === "Passable" ? 179 : result === "Mal fait" ? 68 : 0,
                         result === "Bon" ? 94  : result === "Passable" ? 8   : result === "Mal fait" ? 68 : 0);

        doc.text(`- ${nom} : ${result}`, 10, y);
        y += 8;
        if (y > 270) { doc.addPage(); y = 15; }
      });

      y += 5;
      doc.setTextColor(0,0,0);
      doc.text("Observations :", 10, y);
      y += 8;
      doc.text(doc.splitTextToSize(observations, 180), 10, y);

      for (let i = 0; i < photoDataUrls.length; i++) {
        const imgData = photoDataUrls[i];
        const img = new Image();
        img.src = imgData;

        await new Promise(resolve => {
          img.onload = () => {
            const maxWidth = 85;
            const maxHeight = 85;
            const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
            const w = img.width * ratio;
            const h = img.height * ratio;

            if (i % 2 === 0) {
              doc.addPage();
              doc.setFontSize(14);
              doc.text(`Photos ${i + 1}${photoDataUrls[i + 1] ? " & " + (i + 2) : ""} :`, 10, 15);
            }

            const x = i % 2 === 0 ? 15 : 110;
            const yImg = 25;
            doc.addImage(imgData, 'JPEG', x, yImg, w, h);
            resolve();
          };
        });
      }

      const total = bonCount + passableCount + malCount;
      const scoreGlobal = total === 0 ? 0 : Math.round(((bonCount * 100 + passableCount * 50) / (total * 100)) * 100);

      const chartCanvas = document.getElementById("chartCanvas");
      const chart = new Chart(chartCanvas, {
        type: 'pie',
        data: {
          labels: ['Bon', 'Passable', 'Mal fait'],
          datasets: [{
            data: [bonCount, passableCount, malCount],
            backgroundColor: ['#22c55e', '#eab308', '#ef4444']
          }]
        },
        options: { responsive: false }
      });

      await new Promise(resolve => setTimeout(resolve, 800));
      const chartDataUrl = chartCanvas.toDataURL('image/png');

      doc.addPage();
      doc.setFontSize(16);
      doc.text("Qualit√© Globale du Chantier", 10, 15);
      doc.setFontSize(14);
      doc.text(`Score global : ${scoreGlobal}/100`, 10, 25);
      doc.addImage(chartDataUrl, 'PNG', 30, 40, 150, 150);

      doc.save("rapport-controle-nettoyage.pdf");
    }
  </script>
</body>
</html>
